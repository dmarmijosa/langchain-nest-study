<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LangChain RAG Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #343541;
        color: #ececf1;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .message-row {
        display: flex;
        width: 100%;
      }
      .user-row {
        justify-content: flex-end;
      }
      .ai-row {
        justify-content: flex-start;
      }

      .message-bubble {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 12px;
        font-size: 1rem;
        line-height: 1.5;
      }
      .user-bubble {
        background-color: #19c37d;
        color: white;
        border-bottom-right-radius: 2px;
      }
      .ai-bubble {
        background-color: #444654;
        color: #d1d5db;
        border-bottom-left-radius: 2px;
        border: 1px solid #565869;
      }

      #input-area {
        background: #343541;
        padding: 20px;
        border-top: 1px solid #565869;
      }
      .input-group input {
        background-color: #40414f;
        border: none;
        color: white;
      }
      .input-group input:focus {
        background-color: #40414f;
        color: white;
        box-shadow: none;
        border: 1px solid #19c37d;
      }
      .input-group button {
        background-color: #19c37d;
        border: none;
      }
      .input-group button:hover {
        background-color: #1a885d;
      }
    </style>
  </head>
  <body>
    <div id="chat-container">
      <div class="text-center mt-5" id="placeholder">
        <h3>ü¶ú LangChain + NestJS</h3>
        <p class="text-muted">El sistema est√° listo. Pregunta algo.</p>
      </div>
    </div>

    <div id="input-area">
      <div class="container">
        <div class="input-group input-group-lg">
          <input
            type="text"
            id="userMessage"
            class="form-control"
            placeholder="Env√≠a un mensaje..."
            autocomplete="off"
          />
          <button class="btn btn-primary" id="sendBtn">Enviar</button>
        </div>
      </div>
    </div>

    <script>
      const chatContainer = document.getElementById('chat-container');
      const messageInput = document.getElementById('userMessage');
      const sendBtn = document.getElementById('sendBtn');
      const placeholder = document.getElementById('placeholder');

      // Event Listeners
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        // UI: Limpiar input y esconder placeholder
        if (placeholder) placeholder.style.display = 'none';
        messageInput.value = '';
        messageInput.disabled = true; // Deshabilitar mientras responde

        // UI: Agregar mensaje del usuario
        addMessage(text, 'user');

        // UI: Crear burbuja vac√≠a para la IA
        const aiBubble = addMessage('Thinking...', 'ai');
        aiBubble.innerHTML = ''; // Limpiamos el texto de carga
        let fullResponse = '';

        try {
          const response = await fetch('http://localhost:3000/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text }),
          });

          if (!response.ok) throw new Error('Error en la petici√≥n al servidor');

          const reader = response.body.getReader();
          const decoder = new TextDecoder('utf-8');

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
              // Limpiamos el prefijo "data: "
              const cleanLine = line.replace(/^data: /, '').trim();

              if (cleanLine) {
                try {
                  const json = JSON.parse(cleanLine);
                  if (json.text) {
                    fullResponse += json.text;
                    // Actualizamos el DOM
                    aiBubble.innerHTML = fullResponse.replace(/\n/g, '<br>');
                    // Scroll autom√°tico al fondo
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                  }
                } catch (e) {
                  console.warn('Chunk no parseable:', line);
                }
              }
            }
          }
        } catch (error) {
          aiBubble.innerText = 'Error: ' + error.message;
          aiBubble.style.color = '#ff6b6b';
        } finally {
          messageInput.disabled = false;
          messageInput.focus();
        }
      }

      function addMessage(text, sender) {
        const row = document.createElement('div');
        row.className = `message-row ${sender}-row`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender}-bubble`;
        bubble.innerHTML = text.replace(/\n/g, '<br>');

        row.appendChild(bubble);
        chatContainer.appendChild(row);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return bubble; // Retornamos la burbuja para editarla en tiempo real
      }
    </script>
  </body>
</html>
